<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Stream (amqp_client_eio.Amqp_client_eio.Stream)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.1.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">amqp_client_eio</a> &#x00BB; <a href="../index.html">Amqp_client_eio</a> &#x00BB; Stream</nav><header class="odoc-preamble"><h1>Module <code><span>Amqp_client_eio.Stream</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#note">note</a></li></ul></nav><div class="odoc-content"><p>Extension to Eio.Stream, which allows closing the stream. A closed stream might still hold messages. Once the last message is taken off a close stream, the stream will raise a user defined exception.</p><p>Posting to or closing a closed stream will raise same exception.</p><h2 id="note"><a href="#note" class="anchor"></a>note</h2><p>This is a far from perfect implementation:</p><ul><li>Closing a stream must wait until there is room in the stream.</li></ul><p>This should be re-written to use a promise for indicating that the channel has been closed. This way any pending publishers can be cancelled. Still need to figure out how reliably signal consumers. Well these could wait also wait on the promise. If the promise is ready, they check if there are more messages. ( Could start with a nonblocking read before checking ). Would be so easy if we had a switch (and could fork). We only want one message to be posted.</p><div class="odoc-spec"><div class="spec type" id="type-item" class="anchored"><a href="#type-item" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a item</span></span><span> = <span><span>( <span class="type-var">'a</span>, exn )</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div></div><div class="odoc-spec"><div class="spec type" id="type-t" class="anchored"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> <span>'a t</span></span><span> = </span><span>{</span></code><table><tr id="type-t.mutex" class="anchored"><td class="def record field"><a href="#type-t.mutex" class="anchor"></a><code><span>mutex : <span class="xref-unresolved">Stdlib</span>.Mutex.t;</span></code></td></tr><tr id="type-t.id" class="anchored"><td class="def record field"><a href="#type-t.id" class="anchor"></a><code><span>id : <span class="xref-unresolved">Eio</span>.Private.Ctf.id;</span></code></td></tr><tr id="type-t.capacity" class="anchored"><td class="def record field"><a href="#type-t.capacity" class="anchor"></a><code><span>capacity : int;</span></code></td></tr><tr id="type-t.readers" class="anchored"><td class="def record field"><a href="#type-t.readers" class="anchor"></a><code><span>readers : <span><span><span class="type-var">'a</span> <a href="#type-item">item</a></span> <span class="xref-unresolved">Eio</span>.Private.Waiters.t</span>;</span></code></td></tr><tr id="type-t.writers" class="anchored"><td class="def record field"><a href="#type-t.writers" class="anchor"></a><code><span>writers : <span><span><span>( unit, exn )</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Eio</span>.Private.Waiters.t</span>;</span></code></td></tr><tr id="type-t.items" class="anchored"><td class="def record field"><a href="#type-t.items" class="anchor"></a><code><span>items : <span><span class="type-var">'a</span> <span class="xref-unresolved">Stdlib</span>.Queue.t</span>;</span></code></td></tr><tr id="type-t.condition" class="anchored"><td class="def record field"><a href="#type-t.condition" class="anchor"></a><code><span>condition : <span class="xref-unresolved">Stdlib</span>.Condition.t;</span></code></td></tr><tr id="type-t.flow" class="anchored"><td class="def record field"><a href="#type-t.flow" class="anchor"></a><code><span><span class="keyword">mutable</span> flow : bool;</span></code></td><td class="def-doc"><span class="comment-delim">(*</span><p>If false, receiver will be blocked receiving from the queue</p><span class="comment-delim">*)</span></td></tr><tr id="type-t.closed" class="anchored"><td class="def record field"><a href="#type-t.closed" class="anchor"></a><code><span><span class="keyword">mutable</span> closed : <span>exn option</span>;</span></code></td></tr></table><code><span>}</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-with_lock" class="anchored"><a href="#val-with_lock" class="anchor"></a><code><span><span class="keyword">val</span> with_lock : <span><span class="xref-unresolved">Stdlib</span>.Mutex.t <span class="arrow">&#45;&gt;</span></span> <span><span>( <span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span> )</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-create" class="anchored"><a href="#val-create" class="anchor"></a><code><span><span class="keyword">val</span> create : <span>?capacity:int <span class="arrow">&#45;&gt;</span></span> <span>unit <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="#type-t">t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-send" class="anchored"><a href="#val-send" class="anchor"></a><code><span><span class="keyword">val</span> send : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>?force:bool <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'b</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Push a message onto the stream.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">Closed</span> <p>if the stream has been closed</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">force</span> <p>if true, ignore max_capacity and send will not block</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-wait_empty" class="anchored"><a href="#val-wait_empty" class="anchor"></a><code><span><span class="keyword">val</span> wait_empty : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-receive" class="anchored"><a href="#val-receive" class="anchor"></a><code><span><span class="keyword">val</span> receive : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'b</span></span></code></div><div class="spec-doc"><p>Pop the first element of the stream.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <span class="value">exception</span> <p>if the stream has been closed, and there are no more message on the stream</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-close" class="anchored"><a href="#val-close" class="anchor"></a><code><span><span class="keyword">val</span> close : <span>?message:<span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><span><span class="type-var">'b</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> <span>exn <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Close the stream. Reading from a closed stream will raise the close exception once empty, if the stream was closed with <code>notify_consumers</code>. Closing an already closed stream does nothing (and will not update the close reason).</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">message</span> <p>Post a message onto the queue after its closed, guaranteeing that its the last message on the queue (weak guarantee). Note that this might block until the stream has room</p></li></ul></div></div><div class="odoc-spec"><div class="spec value" id="val-is_empty" class="anchored"><a href="#val-is_empty" class="anchor"></a><code><span><span class="keyword">val</span> is_empty : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-is_full" class="anchored"><a href="#val-is_full" class="anchor"></a><code><span><span class="keyword">val</span> is_full : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div><div class="odoc-spec"><div class="spec value" id="val-is_closed" class="anchored"><a href="#val-is_closed" class="anchor"></a><code><span><span class="keyword">val</span> is_closed : <span><span><span class="type-var">'a</span> <a href="#type-t">t</a></span> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div></div></div></body></html>